<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BookJournal - Carlota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;1,400&display=swap');
        
        :root {
            --bg-main: #0a0e14;
            --accent: #4a7a96;
            --card-bg: #2d2d2d;
            --text-main: #f0f0f0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .serif { font-family: 'Lora', serif; }

        /* Estilo para el contenedor de racha y meta anual */
        .streak-card {
            background: linear-gradient(135deg, #1c1c1c 0%, #141414 100%);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .streak-mini-bar {
            height: 4px;
            background: rgba(255,255,255,0.05);
            border-radius: 2px;
            width: 60px;
            margin-top: 4px;
            overflow: hidden;
        }

        .streak-mini-fill {
            height: 100%;
            background: #f59e0b;
            transition: width 0.5s ease;
        }
        
        .annual-mini-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.5s ease;
        }

        .bookmory-card-container {
            background-color: var(--card-bg);
            border-radius: 24px;
            position: relative;
            padding: 40px 24px 24px 24px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: visible;
        }

        .progress-track {
            position: absolute;
            top: 0;
            left: 24px;
            right: 24px;
            height: 6px;
            background-color: rgba(255,255,255,0.05);
            border-radius: 0 0 10px 10px;
            overflow: hidden;
            z-index: 10;
        }

        .progress-fill {
            height: 100%;
            background-color: #3e6a8a;
            width: 0%; 
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .book-cover-bm {
            width: 110px;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status-card {
            background: #141414;
            border: 1px solid rgba(255,255,255,0.03);
            height: 60px;
            transition: background 0.2s;
        }
        .status-card:active { background: #1c1c1c; }

        .time-remaining-badge {
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 11px;
            color: #aaa;
            margin-top: -15px;
            z-index: 5;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .input-style {
            background-color: #242424;
            border-radius: 16px;
            color: white;
            border: 1px solid transparent;
        }

        .full-page-view {
            position: fixed;
            inset: 0;
            background-color: var(--bg-main);
            z-index: 100;
            overflow-y: auto;
            display: none !important; 
            padding-bottom: 50px;
        }
        
        .full-page-view.active-view {
            display: block !important;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .book-item-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            background: rgba(255,255,255,0.03);
            padding: 8px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }
        .book-item-container:active { transform: scale(0.95); }

        .book-cover-only {
            aspect-ratio: 2/3;
            width: 100%;
            object-fit: cover;
            border-radius: 10px;
            background-color: #1a1a1a;
            cursor: pointer;
        }

        .rating-mini {
            width: 100%;
            display: flex;
            justify-content: center; 
            color: #ffd700;
            font-size: 10px; 
            margin-top: 2px;
        }

        .rating-empty {
            height: 12px;
            margin-top: 2px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            border-top: 1px solid rgba(255,255,255,0.05);
            border-left: 1px solid rgba(255,255,255,0.05);
        }
        .calendar-day {
            aspect-ratio: 0.75; 
            padding: 4px;
            border-right: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }
        .day-number { font-size: 10px; color: #666; margin-bottom: 4px; }
        .day-number.today { color: #3e6a8a; font-weight: bold; }
        .calendar-book-thumb {
            width: 75%; 
            aspect-ratio: 2/3;
            object-fit: cover;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Resumen Anual Estilos */
        .annual-report-card {
            background: linear-gradient(to bottom, #1a1a1a, #0a0a0a);
            border-radius: 32px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 24px;
        }
        .report-stat-box {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 16px;
            text-align: center;
        }
        .chart-container {
            height: 120px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            margin-top: 20px;
            padding: 0 8px;
        }
        .chart-bar {
            flex: 1;
            background: #3e6a8a;
            border-radius: 4px 4px 0 0;
            min-height: 2px;
            transition: height 1s ease-out;
            position: relative;
        }
        .chart-label {
            font-size: 7px;
            text-transform: uppercase;
            color: #555;
            margin-top: 6px;
            text-align: center;
        }

        .timer-display-big {
            font-size: 80px;
            color: #3e6a8a;
            font-weight: 300;
            letter-spacing: -2px;
        }
        .timer-play-btn {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #3e6a8a 0%, #254054 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid rgba(255,255,255,0.1);
        }
        
        .timer-mini-card {
            position: absolute;
            bottom: 40px;
            right: 20px;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 180px;
        }

        .progress-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 300;
            display: none;
            align-items: flex-end;
        }
        .progress-modal-card {
            background: #1c1c1c;
            width: 100%;
            border-radius: 30px 30px 0 0;
            padding: 35px 20px;
            text-align: center;
        }

        .start-reading-btn {
            background-color: #1c1c1c;
            border: 1px solid rgba(255,255,255,0.05);
            padding: 18px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #4a7a96;
            font-weight: 600;
            font-size: 15px;
            width: 100%;
            margin-top: 20px;
        }

        .category-chip {
            background: #141414;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
        }

        .folder-card {
            background: #1c1c1c;
            border-radius: 20px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
            cursor: pointer;
            width: 100%;
            min-height: 220px;
        }
        .folder-stack {
            position: relative;
            width: 70px;
            height: 100px;
            margin-bottom: 10px;
        }
        .folder-stack img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: #111;
        }
        .stack-1 { transform: rotate(-5deg) translate(-5px, 2px); z-index: 1; opacity: 0.5; }
        .stack-2 { transform: rotate(5deg) translate(5px, 1px); z-index: 2; opacity: 0.7; }
        .stack-main { transform: rotate(0deg); z-index: 3; }

        .folder-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #3e6a8a;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            z-index: 10;
        }

        .folder-dates {
            font-size: 8px;
            color: #555;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
            line-height: 1.2;
        }
        
        .folder-rating-stars {
            color: #ffd700;
            font-size: 11px;
            margin-top: 6px;
            font-weight: bold;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .star-rating button {
            font-size: 28px;
            color: #333;
            transition: color 0.2s, transform 0.1s;
        }
        .star-rating button.active {
            color: #ffd700;
        }
        .star-rating button:active { transform: scale(0.9); }

        .stat-badge {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 16px;
            text-align: center;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24 px-4">

    <!-- P√ÅGINA PRINCIPAL -->
    <div id="mainPage" class="max-w-md mx-auto pt-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold">BookJournal</h1>
                <p class="text-[9px] text-stone-500 uppercase tracking-widest font-bold">Biblioteca de Carlota</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openAnnualReport()" class="h-10 w-10 bg-zinc-800 rounded-xl flex items-center justify-center text-lg">üìä</button>
                <button onclick="toggleAddMenu()" class="h-10 w-10 bg-zinc-800 rounded-xl flex items-center justify-center text-lg">Ôºã</button>
            </div>
        </header>

        <!-- BUSCADOR -->
        <div class="mb-6">
            <input type="text" id="searchInput" oninput="searchInMyLibrary()" placeholder="Buscar en mi estanter√≠a..." class="w-full bg-[#1e1e1e] rounded-2xl p-4 text-sm border border-stone-800 focus:outline-none text-white">
            <div id="quickSearchResults" class="mt-4 space-y-4"></div>
        </div>

        <!-- COMPONENTE DE RACHA Y METAS -->
        <div class="space-y-3 mb-6">
            <div class="streak-card" onclick="openGoalModal()">
                <div class="flex items-center gap-4">
                    <div class="text-2xl">üî•</div>
                    <div>
                        <span class="text-[8px] uppercase font-bold text-stone-500 tracking-widest block">Racha actual</span>
                        <p class="text-lg font-bold"><span id="streakDays">0</span> d√≠as</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-[8px] uppercase font-bold text-stone-500 tracking-widest">Meta: <span id="goalLabel">60</span>m</span>
                    <div class="streak-mini-bar"><div id="goalFill" class="streak-mini-fill" style="width: 0%"></div></div>
                </div>
            </div>

            <!-- META ANUAL -->
            <div class="streak-card" onclick="openAnnualGoalModal()">
                <div class="flex items-center gap-4">
                    <div class="text-2xl">üìö</div>
                    <div>
                        <span class="text-[8px] uppercase font-bold text-stone-500 tracking-widest block">Le√≠dos este a√±o</span>
                        <p class="text-lg font-bold"><span id="annualCount">0</span> libros</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-[8px] uppercase font-bold text-stone-500 tracking-widest">Meta: <span id="annualGoalLabel">12</span></span>
                    <div class="streak-mini-bar"><div id="annualGoalFill" class="annual-mini-fill" style="width: 0%"></div></div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN ACTIVA -->
        <div id="activeSection" class="mb-10 empty:hidden"></div>

        <!-- ESTADOS -->
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div onclick="openListView('wishlist')" class="status-card rounded-2xl flex items-center px-4 cursor-pointer">
                <span class="text-[14px] mr-2">‚åõ</span>
                <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Pendientes</span>
                <span class="ml-auto text-xs font-bold text-white/30" id="countWishlist">0</span>
            </div>
            <div onclick="openListView('finished')" class="status-card rounded-2xl flex items-center px-4 cursor-pointer">
                <span class="text-[14px] mr-2">‚úî</span>
                <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Le√≠dos</span>
                <span class="ml-auto text-xs font-bold text-white/30" id="countFinished">0</span>
            </div>
        </div>

        <!-- PR√ìXIMOS -->
        <div onclick="openListView('unreleased')" class="status-card rounded-2xl flex items-center px-4 cursor-pointer mb-3 w-full bg-sky-950/20 border-sky-900/30">
            <span class="text-[14px] mr-2">üîî</span>
            <span class="text-[9px] uppercase tracking-widest font-bold text-sky-500">Pr√≥ximos Lanzamientos</span>
            <span class="ml-auto text-xs font-bold bg-sky-900/40 px-2 py-1 rounded-lg text-sky-400" id="countUnreleased">0</span>
        </div>

        <!-- CALENDARIO -->
        <div onclick="openCalendar()" class="status-card rounded-2xl flex items-center px-4 cursor-pointer mb-3 w-full">
            <span class="text-[14px] mr-2">üìÖ</span>
            <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Calendario de Lectura</span>
            <span class="ml-auto text-[10px] text-white/20 font-mono" id="currentDateLabel"></span>
        </div>

        <!-- ESCRITORES Y EDITORALES -->
        <div class="grid grid-cols-2 gap-3 mb-10">
            <div onclick="openCollection('Writer')" class="status-card rounded-2xl flex items-center px-4 cursor-pointer">
                <span class="text-[14px] mr-2">‚úç</span>
                <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Escritores</span>
                <span class="ml-auto text-xs font-bold text-white/30" id="countWriters">0</span>
            </div>
            <div onclick="openCollection('Publisher')" class="status-card rounded-2xl flex items-center px-4 cursor-pointer">
                <span class="text-[14px] mr-2">üè¢</span>
                <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Editoriales</span>
                <span class="ml-auto text-xs font-bold text-white/30" id="countPublishers">0</span>
            </div>
        </div>

        <!-- COLECCIONES -->
        <div class="mb-10">
            <h4 class="text-[10px] uppercase tracking-[0.2em] font-bold text-stone-600 mb-4 px-1">Mis Colecciones</h4>
            <div class="grid grid-cols-2 gap-3">
                <div onclick="openCollection('Autoconclusivo')" class="category-chip">
                    <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Autoconclusivos</span>
                    <span class="text-xs font-bold text-white/20" id="stat-autoconclusivo">0 libros</span>
                </div>
                <div onclick="openCollection('Serie')" class="category-chip">
                    <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Series</span>
                    <span class="text-xs font-bold text-white/20" id="stat-serie">0 colecciones</span>
                </div>
                <div onclick="openCollection('Saga')" class="category-chip">
                    <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Sagas</span>
                    <span class="text-xs font-bold text-white/20" id="stat-saga">0 colecciones</span>
                </div>
                <div onclick="openCollection('Bilog√≠a')" class="category-chip">
                    <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Bilog√≠as</span>
                    <span class="text-xs font-bold text-white/20" id="stat-bilogia">0 colecciones</span>
                </div>
                <div onclick="openCollection('Trilog√≠a')" class="category-chip">
                    <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Trilog√≠as</span>
                    <span class="text-xs font-bold text-white/20" id="stat-trilogia">0 colecciones</span>
                </div>
                <div onclick="openCollection('Sin finalizar')" class="category-chip">
                    <span class="text-[9px] uppercase tracking-widest font-bold text-stone-400">Sin finalizar</span>
                    <span class="text-xs font-bold text-white/20" id="stat-sinfinalizar">0 colecciones</span>
                </div>
            </div>
        </div>
    </div>

    <!-- P√ÅGINAS DIN√ÅMICAS -->
    <div id="listViewPage" class="full-page-view p-6">
        <header class="flex justify-between items-center mb-10 pt-4">
            <button id="listBackBtn" onclick="handleListBack()" class="h-10 w-10 bg-zinc-800 rounded-xl flex items-center justify-center text-white">‚Üê</button>
            <div class="text-right">
                <h2 id="listTitle" class="text-xl font-bold uppercase tracking-widest truncate max-w-[200px]"></h2>
                <p id="listSubtitle" class="text-[9px] text-stone-500 font-bold uppercase"></p>
            </div>
        </header>
        <div id="listItemsContainer" class="library-grid"></div>
    </div>

    <!-- CALENDARIO VIEW -->
    <div id="calendarPage" class="full-page-view p-6">
        <header class="flex justify-between items-center mb-6 pt-4">
            <button onclick="closeCalendar()" class="h-10 w-10 bg-zinc-800 rounded-xl flex items-center justify-center text-white">‚Üê</button>
            <div class="flex items-center gap-4">
                <button onclick="changeMonth(-1)" class="h-8 w-8 bg-zinc-800 rounded-lg flex items-center justify-center text-white text-xs">‚Üê</button>
                <div class="text-center min-w-[120px]">
                    <h2 id="calendarMonthLabel" class="text-base font-bold uppercase tracking-widest"></h2>
                    <p id="calendarYearLabel" class="text-[9px] text-stone-500 font-bold uppercase"></p>
                </div>
                <button onclick="changeMonth(1)" class="h-8 w-8 bg-zinc-800 rounded-lg flex items-center justify-center text-white text-xs">‚Üí</button>
            </div>
        </header>
        <div class="bg-[#141414] rounded-[32px] overflow-hidden border border-white/5 shadow-2xl mb-8">
            <div class="grid grid-cols-7 text-center py-4 bg-zinc-900/50">
                <span class="text-[8px] font-bold text-stone-600 uppercase">Lu</span>
                <span class="text-[8px] font-bold text-stone-600 uppercase">Ma</span>
                <span class="text-[8px] font-bold text-stone-600 uppercase">Mi</span>
                <span class="text-[8px] font-bold text-stone-600 uppercase">Ju</span>
                <span class="text-[8px] font-bold text-stone-600 uppercase">Vi</span>
                <span class="text-[8px] font-bold text-stone-600 uppercase">Sa</span>
                <span class="text-[8px] font-bold text-stone-600 uppercase">Do</span>
            </div>
            <div id="calendarDaysGrid" class="calendar-grid"></div>
        </div>
    </div>

    <!-- RESUMEN ANUAL VIEW -->
    <div id="annualReportPage" class="full-page-view p-6">
        <header class="flex justify-between items-center mb-8 pt-4">
            <button onclick="closeAnnualReport()" class="h-10 w-10 bg-zinc-800 rounded-xl flex items-center justify-center text-white">‚Üê</button>
            <div class="text-right">
                <h2 class="text-xl font-bold uppercase tracking-widest">Resumen Anual</h2>
                <p id="reportYearLabel" class="text-[9px] text-stone-500 font-bold uppercase"></p>
            </div>
        </header>

        <div class="annual-report-card">
            <h3 class="text-center text-stone-500 text-[10px] uppercase font-bold tracking-[0.3em] mb-6">Mis logros</h3>
            <div class="grid grid-cols-2 gap-3">
                <div class="report-stat-box">
                    <p class="text-3xl font-bold" id="reportTotalBooks">0</p>
                    <p class="text-[8px] uppercase font-bold text-stone-500 tracking-widest mt-1">Libros</p>
                </div>
                <div class="report-stat-box">
                    <p class="text-3xl font-bold" id="reportTotalPages">0</p>
                    <p class="text-[8px] uppercase font-bold text-stone-500 tracking-widest mt-1">P√°ginas</p>
                </div>
                <div class="report-stat-box col-span-2">
                    <p class="text-lg font-bold truncate" id="reportTopAuthor">---</p>
                    <p class="text-[8px] uppercase font-bold text-stone-500 tracking-widest mt-1">Autor m√°s le√≠do</p>
                </div>
            </div>

            <div class="mt-8">
                <h4 class="text-[9px] uppercase font-bold text-stone-500 tracking-widest mb-4">Lecturas por mes</h4>
                <div id="reportChart" class="chart-container"></div>
                <div class="flex justify-between px-2">
                    <span class="chart-label">E</span><span class="chart-label">F</span><span class="chart-label">M</span>
                    <span class="chart-label">A</span><span class="chart-label">M</span><span class="chart-label">J</span>
                    <span class="chart-label">J</span><span class="chart-label">A</span><span class="chart-label">S</span>
                    <span class="chart-label">O</span><span class="chart-label">N</span><span class="chart-label">D</span>
                </div>
            </div>
        </div>

        <div class="mb-10">
            <h4 class="text-[10px] uppercase tracking-[0.2em] font-bold text-stone-600 mb-6 px-1">Top 3 del a√±o</h4>
            <div id="reportTopBooks" class="space-y-4"></div>
        </div>
    </div>

    <!-- DETALLE LIBRO -->
    <div id="detailPage" class="full-page-view p-8">
        <header class="flex justify-between items-center mb-10 pt-4">
            <button onclick="closeDetail()" class="h-10 w-10 bg-zinc-800/80 rounded-xl flex items-center justify-center text-white">‚Üê</button>
            <button id="editFromDetailBtn" class="h-10 w-10 bg-zinc-800/80 rounded-xl flex items-center justify-center text-white">‚úé</button>
        </header>
        <div class="flex flex-col items-center text-center mb-12">
            <img id="detailCover" src="" class="w-48 h-72 object-cover rounded-2xl shadow-2xl mb-8 border-4 border-white/10">
            <h2 id="detailTitle" class="text-3xl font-bold serif italic mb-2 leading-tight"></h2>
            <p id="detailAuthor" class="text-stone-400 uppercase tracking-widest text-sm font-bold"></p>
            
            <div id="detailRatingDisplay" class="mt-4 flex gap-1 text-[#ffd700] text-lg"></div>

            <div id="detailReleaseBadge" class="mt-6 bg-sky-900/30 text-sky-400 px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest border border-sky-400/20 hidden">
                Lanzamiento: <span id="detailReleaseDate"></span>
            </div>
        </div>
        <div id="detailStatsGrid" class="grid grid-cols-2 gap-3 mb-8"></div>
        <div id="detailStartReadingContainer" class="hidden">
            <button id="detailStartReadingBtn" class="start-reading-btn">¬°Empieza a leer!</button>
        </div>
    </div>

    <!-- TIMER PAGE -->
    <div id="timerPage" class="full-page-view p-6 bg-black flex flex-col items-center justify-center overflow-hidden">
        <header class="fixed top-0 left-0 right-0 p-6 flex justify-between items-center z-10">
            <button onclick="closeTimer()" class="h-10 w-10 bg-zinc-800/50 rounded-xl flex items-center justify-center text-white">‚úï</button>
            <button onclick="stopTimerAndRegister()" class="bg-[#3e6a8a] w-10 h-10 flex items-center justify-center rounded-full">‚úì</button>
        </header>
        <div class="flex flex-col items-center">
            <div id="timerDisplay" class="timer-display-big">00:00:00</div>
            <p class="text-stone-500 text-xs uppercase tracking-widest font-bold mt-2 mb-12">Tiempo de lectura</p>
            <button onclick="toggleTimer()" id="timerCtrlBtn" class="timer-play-btn shadow-2xl">
                <span id="timerBtnIcon" class="text-white text-3xl">‚è∏</span>
            </button>
        </div>
        <div class="timer-mini-card">
            <img id="timerBookCover" class="w-10 h-14 object-cover rounded-lg">
            <div>
                <h4 id="timerBookTitle" class="text-[10px] font-bold leading-tight truncate"></h4>
                <p id="timerBookAuthor" class="text-[8px] text-stone-500 uppercase font-bold tracking-widest truncate"></p>
            </div>
        </div>
    </div>

    <!-- MODAL META DIARIA -->
    <div id="goalModal" class="fixed inset-0 bg-black/90 z-[300] hidden flex items-center justify-center p-6">
        <div class="bg-[#181818] w-full max-w-xs rounded-[32px] p-8 text-center border border-white/5">
            <h3 class="text-xl font-bold mb-1">Meta Diaria</h3>
            <p class="text-[10px] text-stone-500 uppercase font-bold tracking-widest mb-6">Minutos de lectura</p>
            <input type="number" id="goalInput" class="w-full bg-black rounded-2xl p-6 text-4xl font-bold text-center text-amber-500 mb-6 outline-none border border-white/5">
            <button onclick="saveGoal()" class="w-full bg-amber-600 py-4 rounded-2xl font-bold">Guardar</button>
            <button onclick="closeGoalModal()" class="w-full mt-4 text-stone-600 text-[10px] uppercase font-bold">Cerrar</button>
        </div>
    </div>

    <!-- MODAL META ANUAL -->
    <div id="annualGoalModal" class="fixed inset-0 bg-black/90 z-[300] hidden flex items-center justify-center p-6">
        <div class="bg-[#181818] w-full max-w-xs rounded-[32px] p-8 text-center border border-white/5">
            <h3 class="text-xl font-bold mb-1">Meta Anual</h3>
            <p class="text-[10px] text-stone-500 uppercase font-bold tracking-widest mb-6">Libros este a√±o</p>
            <input type="number" id="annualGoalInput" class="w-full bg-black rounded-2xl p-6 text-4xl font-bold text-center text-emerald-500 mb-6 outline-none border border-white/5">
            <button onclick="saveAnnualGoal()" class="w-full bg-emerald-600 py-4 rounded-2xl font-bold">Guardar</button>
            <button onclick="closeAnnualGoalModal()" class="w-full mt-4 text-stone-600 text-[10px] uppercase font-bold">Cerrar</button>
        </div>
    </div>

    <!-- FORMULARIO LIBRO -->
    <div id="bookModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm z-[200] hidden flex justify-center items-end sm:items-center">
        <div class="modal-content bg-[#181818] w-full max-w-md rounded-t-[40px] sm:rounded-[40px] p-8 max-h-[92vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold">Libro</h3>
                <button onclick="closeModal()" class="text-stone-500 text-2xl">‚úï</button>
            </div>
            <div class="space-y-5">
                <div class="flex justify-center mb-2">
                    <div onclick="document.getElementById('manualCoverInput').click()" class="w-24 h-32 bg-zinc-900 rounded-xl flex items-center justify-center border border-zinc-800 cursor-pointer overflow-hidden relative">
                        <img id="formPreview" src="" class="w-full h-full object-cover hidden">
                        <span id="previewPlaceholder" class="text-2xl opacity-30">üì∑</span>
                    </div>
                    <input type="file" id="manualCoverInput" accept="image/*" class="hidden" onchange="handleManualCoverUpload(event)">
                </div>

                <div class="bg-zinc-900/40 border border-white/5 rounded-2xl p-4 space-y-3">
                    <input id="formTitle" placeholder="T√≠tulo" class="w-full p-3 input-style text-sm">
                    <input id="formAuthor" placeholder="Autor" class="w-full p-3 input-style text-sm">
                    <input id="formPageTotal" type="number" placeholder="Total de p√°ginas" class="w-full p-3 input-style text-sm">
                </div>

                <div class="bg-zinc-900/40 border border-white/5 rounded-2xl p-4 space-y-3">
                    <select id="formSeriesType" onchange="toggleSeriesFields()" class="w-full p-3 input-style text-sm">
                        <option value="Autoconclusivo">Autoconclusivo</option>
                        <option value="Serie">Serie</option>
                        <option value="Saga">Saga</option>
                        <option value="Bilog√≠a">Bilog√≠a</option>
                        <option value="Trilog√≠a">Trilog√≠a</option>
                        <option value="Sin finalizar">Sin finalizar</option>
                    </select>
                    <div id="dynamicSeriesFields" class="hidden space-y-3">
                        <input id="formSeriesName" placeholder="Nombre de la serie/saga" class="w-full p-3 input-style text-sm">
                        <input id="formSeriesNumber" type="number" placeholder="N√∫mero del libro (Tomo)" class="w-full p-3 input-style text-sm">
                    </div>
                </div>

                <div class="bg-zinc-900/40 border border-white/5 rounded-2xl p-4 space-y-3">
                    <input id="formPublisher" placeholder="Editorial" class="w-full p-3 input-style text-sm mb-2">
                    <label class="text-[9px] text-stone-500 font-bold uppercase block mb-1">Fecha de publicaci√≥n</label>
                    <div class="grid grid-cols-3 gap-2">
                        <input id="formDay" type="number" placeholder="DD" class="p-3 input-style text-xs text-center">
                        <input id="formMonth" type="number" placeholder="MM" class="p-3 input-style text-xs text-center">
                        <input id="formYear" type="number" placeholder="AAAA" class="p-3 input-style text-xs text-center">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <select id="formStatus" onchange="handleStatusChange()" class="w-full p-3 input-style text-xs">
                        <option value="wishlist">Pendiente</option>
                        <option value="reading">Leyendo</option>
                        <option value="finished">Le√≠do</option>
                    </select>
                    <select id="formFormat" class="w-full p-3 input-style text-xs">
                        <option value="F√≠sico">F√≠sico</option>
                        <option value="Digital">Digital</option>
                    </select>
                </div>

                <div id="manualDatesContainer" class="hidden bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 space-y-4">
                    <div id="formStartDateField">
                        <label class="text-[9px] text-stone-500 font-bold uppercase block mb-2">Fecha de inicio (DD/MM/AAAA)</label>
                        <input id="formManualStartDate" placeholder="P.ej. 01/01/2024" class="w-full p-3 input-style text-sm text-center">
                    </div>
                    <div id="formEndDateField" class="hidden">
                        <label class="text-[9px] text-stone-500 font-bold uppercase block mb-2">Fecha de fin (DD/MM/AAAA)</label>
                        <input id="formManualEndDate" placeholder="P.ej. 15/01/2024" class="w-full p-3 input-style text-sm text-center">
                    </div>
                </div>

                <div id="formRatingContainer" class="hidden bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 text-center">
                    <label class="text-[9px] text-stone-500 font-bold uppercase block mb-2">Valoraci√≥n</label>
                    <div class="star-rating" id="formStarRating">
                        <button onclick="setRating(1, 'form')">‚òÖ</button>
                        <button onclick="setRating(2, 'form')">‚òÖ</button>
                        <button onclick="setRating(3, 'form')">‚òÖ</button>
                        <button onclick="setRating(4, 'form')">‚òÖ</button>
                        <button onclick="setRating(5, 'form')">‚òÖ</button>
                    </div>
                </div>

                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800">
                    <label class="text-[9px] text-stone-500 font-bold uppercase block mb-2">P√°gina Actual</label>
                    <input id="formPageNow" type="number" class="w-full p-3 input-style text-center font-bold text-sky-400 text-lg">
                </div>

                <button onclick="processBook()" class="w-full p-4 bg-sky-900 text-white rounded-2xl font-bold uppercase text-xs tracking-widest">Guardar</button>
                <button id="deleteBtn" onclick="deleteBook()" class="w-full text-red-900/40 text-[10px] font-bold uppercase py-2 hidden">Eliminar Libro</button>
            </div>
        </div>
    </div>

    <!-- MODAL PROGRESO TIMER -->
    <div id="timerProgressModal" class="progress-modal-overlay">
        <div class="progress-modal-card">
            <div id="standardProgressInputs">
                <h3 class="text-xl font-bold mb-2">¬øEn qu√© p√°gina te has quedado?</h3>
                <input type="number" id="timerNewPageInput" class="w-full bg-zinc-900 rounded-2xl p-6 text-4xl font-bold text-center text-sky-400 mb-2" placeholder="0">
                <p id="sessionStatsLabel" class="text-[10px] text-stone-500 font-bold uppercase tracking-widest mb-6"></p>
            </div>
            
            <div id="ratingInputContainer" class="hidden">
                <h3 class="text-xl font-bold mb-2">¬°Lectura terminada!</h3>
                <p class="text-stone-500 text-[10px] font-bold uppercase tracking-widest mb-4">Danos tu valoraci√≥n</p>
                <div class="star-rating" id="timerStarRating">
                    <button onclick="setRating(1, 'timer')">‚òÖ</button>
                    <button onclick="setRating(2, 'timer')">‚òÖ</button>
                    <button onclick="setRating(3, 'timer')">‚òÖ</button>
                    <button onclick="setRating(4, 'timer')">‚òÖ</button>
                    <button onclick="setRating(5, 'timer')">‚òÖ</button>
                </div>
            </div>

            <button onclick="confirmTimerProgress()" class="w-full bg-[#3e6a8a] py-5 rounded-2xl font-bold uppercase text-xs tracking-[0.2em]">Guardar Sesi√≥n</button>
            <button onclick="hideTimerProgress()" class="mt-6 text-stone-500 text-[9px] font-bold uppercase tracking-widest">Descartar sesi√≥n</button>
        </div>
    </div>

    <script>
        const APP_KEY = 'bookjournal_carlota_v1';
        let myLibrary = JSON.parse(localStorage.getItem(APP_KEY)) || [];
        let readingLogs = JSON.parse(localStorage.getItem(APP_KEY + '_logs')) || [];
        let dailyGoal = parseInt(localStorage.getItem(APP_KEY + '_goal')) || 60;
        let annualGoal = parseInt(localStorage.getItem(APP_KEY + '_annual_goal')) || 12;
        
        let editingId = null;
        let currentCover = null;
        let currentRating = 0;
        let isTimerRunning = false;
        let timerSeconds = 0;
        let timerInterval = null;
        let calMonth = new Date().getMonth();
        let calYear = new Date().getFullYear();
        let navigationStack = [];

        function save() {
            localStorage.setItem(APP_KEY, JSON.stringify(myLibrary));
            localStorage.setItem(APP_KEY + '_logs', JSON.stringify(readingLogs));
            localStorage.setItem(APP_KEY + '_goal', dailyGoal);
            localStorage.setItem(APP_KEY + '_annual_goal', annualGoal);
            updateStats();
        }

        function updateStreakUI() {
            const todayStr = getCurrentDate();
            const activityByDate = {};
            readingLogs.forEach(l => {
                activityByDate[l.date] = (activityByDate[l.date] || 0) + (l.duration || 0);
            });

            const todayMinutes = Math.floor((activityByDate[todayStr] || 0) / 60);
            
            let streak = 0;
            let checkDate = new Date();
            
            while (true) {
                const dStr = `${checkDate.getDate().toString().padStart(2,'0')}/${(checkDate.getMonth() + 1).toString().padStart(2,'0')}/${checkDate.getFullYear()}`;
                const mins = Math.floor((activityByDate[dStr] || 0) / 60);
                
                if (mins >= dailyGoal) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (dStr === todayStr) {
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            document.getElementById('streakDays').innerText = streak;
            document.getElementById('goalLabel').innerText = dailyGoal;
            const percentage = Math.min((todayMinutes / dailyGoal) * 100, 100);
            document.getElementById('goalFill').style.width = percentage + '%';

            // Actualizar Meta Anual
            updateAnnualGoalUI();
        }

        function updateAnnualGoalUI() {
            const currentYear = new Date().getFullYear().toString();
            const booksThisYear = myLibrary.filter(b => {
                if (b.status !== 'finished' || !b.endDate) return false;
                const parts = b.endDate.split('/');
                return parts[2] === currentYear;
            });

            const count = booksThisYear.length;
            document.getElementById('annualCount').innerText = count;
            document.getElementById('annualGoalLabel').innerText = annualGoal;
            const percentage = Math.min((count / annualGoal) * 100, 100);
            document.getElementById('annualGoalFill').style.width = percentage + '%';
        }

        // --- RESUMEN ANUAL LOGIC ---
        function openAnnualReport() {
            const year = new Date().getFullYear();
            const yearStr = year.toString();
            document.getElementById('reportYearLabel').innerText = year;
            
            const booksThisYear = myLibrary.filter(b => {
                if (b.status !== 'finished' || !b.endDate) return false;
                return b.endDate.split('/')[2] === yearStr;
            });

            // Stats
            document.getElementById('reportTotalBooks').innerText = booksThisYear.length;
            const totalPages = booksThisYear.reduce((acc, b) => acc + (b.pageTotal || 0), 0);
            document.getElementById('reportTotalPages').innerText = totalPages;

            const authors = {};
            booksThisYear.forEach(b => {
                if (b.author && b.author !== 'Autor Desconocido') {
                    authors[b.author] = (authors[b.author] || 0) + 1;
                }
            });
            let topAuthor = "---";
            let maxA = 0;
            for (let a in authors) if(authors[a] > maxA) { maxA = authors[a]; topAuthor = a; }
            document.getElementById('reportTopAuthor').innerText = topAuthor;

            // Chart
            const monthlyCounts = new Array(12).fill(0);
            booksThisYear.forEach(b => {
                const monthIdx = parseInt(b.endDate.split('/')[1]) - 1;
                monthlyCounts[monthIdx]++;
            });
            const maxMonth = Math.max(...monthlyCounts, 1);
            document.getElementById('reportChart').innerHTML = monthlyCounts.map(count => {
                const h = (count / maxMonth) * 100;
                return `<div class="chart-bar" style="height: ${h}%"></div>`;
            }).join('');

            // Top 3
            const top3 = [...booksThisYear].sort((a,b) => (b.rating || 0) - (a.rating || 0)).slice(0, 3);
            document.getElementById('reportTopBooks').innerHTML = top3.map((b, i) => `
                <div class="flex items-center gap-4 bg-zinc-900/30 p-4 rounded-2xl border border-white/5" onclick="viewDetail(${b.id})">
                    <div class="text-xl font-bold italic opacity-20 serif">#${i+1}</div>
                    <img src="${b.cover}" class="w-12 h-16 object-cover rounded shadow">
                    <div class="flex-1 truncate">
                        <h4 class="text-sm font-bold truncate">${b.title}</h4>
                        <div class="text-[#ffd700] text-[10px] mt-1">${'‚òÖ'.repeat(b.rating)}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('annualReportPage').classList.add('active-view');
        }

        function closeAnnualReport() {
            document.getElementById('annualReportPage').classList.remove('active-view');
        }

        function openGoalModal() {
            document.getElementById('goalInput').value = dailyGoal;
            document.getElementById('goalModal').classList.remove('hidden');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.add('hidden');
        }

        function saveGoal() {
            const val = parseInt(document.getElementById('goalInput').value);
            if (!isNaN(val) && val > 0) {
                dailyGoal = val;
                save();
                closeGoalModal();
                updateStreakUI();
            }
        }

        // Funciones Meta Anual
        function openAnnualGoalModal() {
            document.getElementById('annualGoalInput').value = annualGoal;
            document.getElementById('annualGoalModal').classList.remove('hidden');
        }

        function closeAnnualGoalModal() {
            document.getElementById('annualGoalModal').classList.add('hidden');
        }

        function saveAnnualGoal() {
            const val = parseInt(document.getElementById('annualGoalInput').value);
            if (!isNaN(val) && val > 0) {
                annualGoal = val;
                save();
                closeAnnualGoalModal();
                updateAnnualGoalUI();
            }
        }

        function checkUnreleased(book) {
            if (!book.year || !book.month || !book.day) return false;
            const release = new Date(book.year, book.month - 1, book.day);
            const today = new Date();
            today.setHours(0,0,0,0);
            return release > today;
        }

        function getCurrentDate() {
            const today = new Date();
            return `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth() + 1).toString().padStart(2,'0')}/${today.getFullYear()}`;
        }

        function parseDate(str) {
            if(!str) return null;
            const parts = str.split('/');
            if(parts.length < 3) return null;
            return new Date(parts[2], parts[1]-1, parts[0]);
        }

        function calculateReadingMetrics(bookId) {
            const logs = readingLogs.filter(l => l.bookId === bookId);
            if (logs.length === 0) return null;

            let totalSeconds = 0;
            let totalPages = 0;
            logs.forEach(l => {
                totalSeconds += l.duration || 0;
                totalPages += l.pagesRead || 0;
            });

            if (totalPages === 0 || totalSeconds === 0) return null;

            const pagesPerMinute = (totalPages / (totalSeconds / 60)).toFixed(2);
            const minutesPerPage = (totalSeconds / 60 / totalPages).toFixed(2);
            
            return {
                ppm: pagesPerMinute,
                mpp: minutesPerPage,
                avgSession: Math.round(totalSeconds / logs.length / 60)
            };
        }

        function getEstimatedTime(book) {
            const metrics = calculateReadingMetrics(book.id);
            if (!metrics || !book.pageTotal) return null;

            const remainingPages = book.pageTotal - (book.pageNow || 0);
            if (remainingPages <= 0) return "Terminado";

            const totalMinutesNeeded = remainingPages * parseFloat(metrics.mpp);
            const hours = Math.floor(totalMinutesNeeded / 60);
            const minutes = Math.round(totalMinutesNeeded % 60);

            if (hours === 0) return `${minutes} min restates`;
            return `${hours}h ${minutes}m restantes`;
        }

        function updateStats() {
            const unreleased = myLibrary.filter(b => checkUnreleased(b));
            const wishlist = myLibrary.filter(b => b.status === 'wishlist' && !checkUnreleased(b));
            const finished = myLibrary.filter(b => b.status === 'finished');

            document.getElementById('countUnreleased').innerText = unreleased.length;
            document.getElementById('countWishlist').innerText = wishlist.length;
            document.getElementById('countFinished').innerText = finished.length;
            
            document.getElementById('countWriters').innerText = new Set(myLibrary.map(b => b.author).filter(a => a && a !== 'Autor Desconocido')).size;
            document.getElementById('countPublishers').innerText = new Set(myLibrary.map(b => b.publisher).filter(Boolean)).size;
            
            const collectionMapping = {
                'Autoconclusivo': 'stat-autoconclusivo',
                'Serie': 'stat-serie',
                'Saga': 'stat-saga',
                'Bilog√≠a': 'stat-bilogia',
                'Trilog√≠a': 'stat-trilogia',
                'Sin finalizar': 'stat-sinfinalizar'
            };

            Object.keys(collectionMapping).forEach(type => {
                const elId = collectionMapping[type];
                const el = document.getElementById(elId);
                if (el) {
                    const booksInType = myLibrary.filter(b => b.seriesType === type);
                    if (type === 'Autoconclusivo') {
                        el.innerText = `${booksInType.length} libros`;
                    } else {
                        const uniqueSeries = new Set(booksInType.map(b => b.seriesName).filter(name => name && name.trim() !== ''));
                        const count = uniqueSeries.size;
                        el.innerText = `${count} ${count === 1 ? 'colecci√≥n' : 'colecciones'}`;
                    }
                }
            });

            document.getElementById('currentDateLabel').innerText = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }).toUpperCase();
            updateStreakUI();
        }

        function renderActive() {
            const container = document.getElementById('activeSection');
            const active = myLibrary.find(b => b.status === 'reading');
            
            if (!active) {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            const porcentaje = Math.min(((active.pageNow || 0) / (active.pageTotal || 1)) * 100, 100);
            const estimate = getEstimatedTime(active);
            const metrics = calculateReadingMetrics(active.id);

            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="w-full px-4 mb-2 flex justify-between items-end">
                        <span class="text-xl font-medium text-gray-400 serif italic">Leyendo ahora</span>
                        <div class="text-xl font-medium text-gray-400">P√°g. ${active.pageNow} <span class="text-xs opacity-40">/ ${active.pageTotal}</span></div>
                    </div>
                    <div class="bookmory-card-container w-full" onclick="viewDetail(${active.id})">
                        <div class="progress-track"><div class="progress-fill" style="width: ${porcentaje}%"></div></div>
                        <h3 class="text-2xl font-medium text-white mb-1 leading-tight">${active.title}</h3>
                        <p class="text-stone-500 text-xs mb-4 uppercase tracking-widest font-bold">${active.author}</p>
                        <div class="flex gap-6 items-start">
                            <img src="${active.cover || ''}" class="book-cover-bm">
                            <div class="flex-1 pt-2 flex flex-col justify-between min-h-[160px]">
                                <div class="flex flex-col gap-1 items-start">
                                    <span class="text-sky-500/80 text-[10px] font-bold uppercase border border-sky-500/20 px-2 py-1 rounded-lg">${active.format}</span>
                                    ${metrics ? `<span class="text-amber-500/80 text-[8px] font-bold uppercase mt-1">‚ö° ${metrics.ppm} p√°g/min</span>` : ''}
                                </div>
                                <div class="flex items-center gap-4 bg-zinc-900/50 p-3 rounded-2xl w-fit border border-white/5">
                                    <button onclick="event.stopPropagation(); openTimer()" class="w-8 h-8 flex items-center justify-center bg-sky-900/40 rounded-full">‚è±</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="time-remaining-badge">
                        <span>${Math.round(porcentaje)}%</span>
                        ${estimate ? `<span class="opacity-30 mx-1">|</span><span>${estimate}</span>` : ''}
                    </div>
                </div>`;
        }

        function renderAll() { 
            document.querySelectorAll('.full-page-view').forEach(view => view.classList.remove('active-view'));
            document.getElementById('mainPage').style.display = 'block';
            renderActive(); 
            updateStats(); 
        }

        function toggleAddMenu() { 
            editingId = null; 
            resetForm(); 
            document.getElementById('modalTitle').innerText = "A√±adir Libro"; 
            document.getElementById('deleteBtn').classList.add('hidden'); 
            document.getElementById('bookModal').classList.remove('hidden'); 
            handleStatusChange();
        }

        function closeModal() { document.getElementById('bookModal').classList.add('hidden'); }
        function toggleSeriesFields() { document.getElementById('dynamicSeriesFields').classList.toggle('hidden', document.getElementById('formSeriesType').value === 'Autoconclusivo'); }
        
        function handleStatusChange() {
            const status = document.getElementById('formStatus').value;
            const datesContainer = document.getElementById('manualDatesContainer');
            const endField = document.getElementById('formEndDateField');
            const ratingContainer = document.getElementById('formRatingContainer');

            ratingContainer.classList.toggle('hidden', status !== 'finished');
            
            if (status === 'wishlist') {
                datesContainer.classList.add('hidden');
            } else {
                datesContainer.classList.remove('hidden');
                endField.classList.toggle('hidden', status !== 'finished');
            }
        }

        function setRating(val, context) {
            currentRating = val;
            const containerId = context === 'form' ? 'formStarRating' : 'timerStarRating';
            const btns = document.querySelectorAll(`#${containerId} button`);
            btns.forEach((btn, idx) => btn.classList.toggle('active', idx < val));
        }

        function handleManualCoverUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentCover = ev.target.result;
                document.getElementById('formPreview').src = currentCover;
                document.getElementById('formPreview').classList.remove('hidden');
                document.getElementById('previewPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function processBook() {
            const title = document.getElementById('formTitle').value;
            if (!title) return;
            
            const status = document.getElementById('formStatus').value;
            let startDate = document.getElementById('formManualStartDate').value || null;
            let endDate = document.getElementById('formManualEndDate').value || null;

            if (!editingId) {
                if (status === 'reading' && !startDate) startDate = getCurrentDate();
                if (status === 'finished' && !startDate) startDate = getCurrentDate();
                if (status === 'finished' && !endDate) endDate = getCurrentDate();
            }

            const book = {
                id: editingId || Date.now(),
                title: title,
                author: document.getElementById('formAuthor').value || 'Autor Desconocido',
                pageTotal: parseInt(document.getElementById('formPageTotal').value) || 0,
                pageNow: parseInt(document.getElementById('formPageNow').value) || 0,
                status: status,
                format: document.getElementById('formFormat').value,
                seriesType: document.getElementById('formSeriesType').value,
                seriesName: document.getElementById('formSeriesName').value || '',
                seriesNumber: parseInt(document.getElementById('formSeriesNumber').value) || 0,
                publisher: document.getElementById('formPublisher').value,
                day: parseInt(document.getElementById('formDay').value) || null,
                month: parseInt(document.getElementById('formMonth').value) || null,
                year: parseInt(document.getElementById('formYear').value) || null,
                cover: currentCover,
                rating: status === 'finished' ? currentRating : 0,
                startDate: startDate,
                endDate: status === 'finished' ? endDate : null
            };

            if (editingId) {
                const idx = myLibrary.findIndex(b => b.id === editingId);
                myLibrary[idx] = book;
            } else {
                myLibrary.unshift(book);
            }
            save(); closeModal(); renderAll();
        }

        function editBook(id) {
            const b = myLibrary.find(x => x.id === id);
            if (!b) return;
            editingId = id;
            document.getElementById('formTitle').value = b.title;
            document.getElementById('formAuthor').value = b.author;
            document.getElementById('formPageTotal').value = b.pageTotal;
            document.getElementById('formPageNow').value = b.pageNow;
            document.getElementById('formStatus').value = b.status;
            document.getElementById('formFormat').value = b.format;
            document.getElementById('formSeriesType').value = b.seriesType;
            document.getElementById('formSeriesName').value = b.seriesName || '';
            document.getElementById('formSeriesNumber').value = b.seriesNumber || '';
            document.getElementById('formPublisher').value = b.publisher || '';
            document.getElementById('formDay').value = b.day || '';
            document.getElementById('formMonth').value = b.month || '';
            document.getElementById('formYear').value = b.year || '';
            document.getElementById('formManualStartDate').value = b.startDate || '';
            document.getElementById('formManualEndDate').value = b.endDate || '';

            currentRating = b.rating || 0;
            setRating(currentRating, 'form');
            currentCover = b.cover;
            if (currentCover) {
                document.getElementById('formPreview').src = currentCover;
                document.getElementById('formPreview').classList.remove('hidden');
                document.getElementById('previewPlaceholder').classList.add('hidden');
            }
            toggleSeriesFields();
            handleStatusChange();
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('bookModal').classList.remove('hidden');
        }

        function deleteBook() { if(editingId) { myLibrary = myLibrary.filter(b => b.id !== editingId); save(); closeModal(); renderAll(); } }

        function resetForm() {
            ['formTitle', 'formAuthor', 'formPageTotal', 'formPageNow', 'formSeriesName', 'formSeriesNumber', 'formPublisher', 'formDay', 'formMonth', 'formYear', 'formManualStartDate', 'formManualEndDate'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('formStatus').value = 'wishlist';
            document.getElementById('formSeriesType').value = 'Autoconclusivo';
            document.getElementById('formPreview').classList.add('hidden');
            document.getElementById('previewPlaceholder').classList.remove('hidden');
            currentCover = null; 
            currentRating = 0;
            setRating(0, 'form');
            toggleSeriesFields();
        }

        function openListView(mode) {
            navigationStack = [];
            let books = [];
            let title = "";

            if (mode === 'unreleased') {
                books = myLibrary.filter(b => checkUnreleased(b));
                title = "Pr√≥ximos";
            } else if (mode === 'wishlist') {
                books = myLibrary.filter(b => b.status === 'wishlist' && !checkUnreleased(b));
                title = "Pendientes";
            } else if (mode === 'finished') {
                books = myLibrary.filter(b => b.status === 'finished');
                title = "Le√≠dos";
            }

            document.getElementById('listTitle').innerText = title;
            document.getElementById('listSubtitle').innerText = `${books.length} libros`;
            
            document.getElementById('listItemsContainer').innerHTML = books.map(b => {
                let starsHtml = (b.status === 'finished' && b.rating > 0) ? `<div class="rating-mini">${'‚òÖ'.repeat(b.rating)}</div>` : `<div class="rating-empty"></div>`;
                return `<div class="book-item-container" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="book-cover-only">${starsHtml}</div>`;
            }).join('');

            document.getElementById('listViewPage').classList.add('active-view');
        }

        function viewDetail(id) {
            const b = myLibrary.find(x => x.id === id);
            if (!b) return;
            document.getElementById('detailTitle').innerText = b.title;
            document.getElementById('detailAuthor').innerText = b.author;
            document.getElementById('detailCover').src = b.cover || '';
            
            const starsContainer = document.getElementById('detailRatingDisplay');
            starsContainer.innerHTML = (b.status === 'finished' && b.rating > 0) ? '‚òÖ'.repeat(b.rating) + '<span class="opacity-10">' + '‚òÖ'.repeat(5 - b.rating) + '</span>' : '';

            const metrics = calculateReadingMetrics(b.id);

            document.getElementById('detailStatsGrid').innerHTML = `
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">Editorial</p><p class="text-xs font-medium">${b.publisher || '---'}</p></div>
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">P√°ginas</p><p class="text-xs font-medium">${b.pageTotal}</p></div>
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">Inicio</p><p class="text-xs font-medium">${b.startDate || '---'}</p></div>
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">Fin</p><p class="text-xs font-medium">${b.endDate || '---'}</p></div>
                ${metrics ? `
                <div class="stat-badge col-span-2 flex justify-around py-3 bg-sky-950/20">
                    <div><p class="text-[8px] text-sky-500 uppercase font-bold">Velocidad</p><p class="text-xs font-bold">${metrics.ppm} p√°g/m</p></div>
                    <div><p class="text-[8px] text-sky-500 uppercase font-bold">Ritmo</p><p class="text-xs font-bold">${metrics.mpp} m/p√°g</p></div>
                    <div><p class="text-[8px] text-sky-500 uppercase font-bold">Sesi√≥n Media</p><p class="text-xs font-bold">${metrics.avgSession} min</p></div>
                </div>` : ''}`;
            
            document.getElementById('detailStartReadingContainer').classList.toggle('hidden', b.status !== 'wishlist' || checkUnreleased(b));
            document.getElementById('detailStartReadingBtn').onclick = () => { b.status = 'reading'; b.startDate = getCurrentDate(); save(); closeDetail(); renderAll(); };
            document.getElementById('editFromDetailBtn').onclick = () => { closeDetail(); editBook(id); };
            document.getElementById('detailPage').classList.add('active-view');
        }

        function openTimer() {
            const active = myLibrary.find(b => b.status === 'reading');
            if (!active) return;
            document.getElementById('timerBookTitle').innerText = active.title;
            document.getElementById('timerBookAuthor').innerText = active.author;
            document.getElementById('timerBookCover').src = active.cover || '';
            document.getElementById('timerPage').classList.add('active-view');
            if(!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    const h = Math.floor(timerSeconds/3600).toString().padStart(2,'0'), m = Math.floor((timerSeconds%3600)/60).toString().padStart(2,'0'), s = (timerSeconds%60).toString().padStart(2,'0');
                    document.getElementById('timerDisplay').innerText = `${h}:${m}:${s}`;
                }, 1000);
            }
        }

        function toggleTimer() { if(isTimerRunning){ clearInterval(timerInterval); isTimerRunning=false; document.getElementById('timerBtnIcon').innerText='‚ñ∂'; } else openTimer(); }
        
        function stopTimerAndRegister() { 
            const a = myLibrary.find(b => b.status === 'reading'); 
            if(a){ 
                document.getElementById('timerNewPageInput').value=a.pageNow; 
                const checkStats = () => {
                    const p = parseInt(document.getElementById('timerNewPageInput').value);
                    const pagesRead = Math.max(0, p - a.pageNow);
                    const isF = p >= a.pageTotal && a.pageTotal > 0;
                    
                    const sessionMinutes = timerSeconds / 60;
                    const ppm = sessionMinutes > 0 ? (pagesRead / sessionMinutes).toFixed(2) : 0;
                    
                    document.getElementById('sessionStatsLabel').innerText = `Has le√≠do ${pagesRead} p√°ginas (${ppm} PPM)`;
                    document.getElementById('standardProgressInputs').classList.toggle('hidden', isF);
                    document.getElementById('ratingInputContainer').classList.toggle('hidden', !isF);
                };
                document.getElementById('timerNewPageInput').oninput = checkStats;
                checkStats();
                document.getElementById('timerProgressModal').style.display='flex'; 
            } 
        }

        function confirmTimerProgress() {
            const a = myLibrary.find(b => b.status === 'reading'), p = parseInt(document.getElementById('timerNewPageInput').value);
            if(a && !isNaN(p)){
                const pagesRead = Math.max(0, p - a.pageNow);
                a.pageNow = p;
                
                readingLogs.push({ 
                    date: getCurrentDate(), 
                    bookId: a.id, 
                    duration: timerSeconds,
                    pagesRead: pagesRead
                });

                if(p >= a.pageTotal && a.pageTotal > 0){ 
                    a.status = 'finished'; 
                    a.endDate = getCurrentDate(); 
                    a.rating = currentRating; 
                }
                save();
            }
            closeTimer(); hideTimerProgress(); renderAll();
        }

        function hideTimerProgress() { document.getElementById('timerProgressModal').style.display = 'none'; document.getElementById('standardProgressInputs').classList.remove('hidden'); document.getElementById('ratingInputContainer').classList.add('hidden'); currentRating = 0; setRating(0, 'timer'); }
        function closeTimer() { clearInterval(timerInterval); isTimerRunning = false; timerSeconds = 0; document.getElementById('timerPage').classList.remove('active-view'); }

        function searchInMyLibrary() {
            const t = document.getElementById('searchInput').value.toLowerCase(), r = document.getElementById('quickSearchResults');
            if(t.length > 0){
                const f = myLibrary.filter(b => b.title.toLowerCase().includes(t) || b.author.toLowerCase().includes(t));
                r.innerHTML = f.map(b => `<div class="bg-zinc-900/50 p-4 rounded-2xl flex gap-4 items-center border border-white/5" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="w-10 h-14 object-cover rounded shadow"><div><h4 class="text-sm font-bold">${b.title}</h4><p class="text-[9px] text-stone-500 uppercase font-bold">${b.author}</p></div></div>`).join('');
            } else r.innerHTML = '';
        }

        function handleListBack() {
            if (navigationStack.length > 0) {
                const prev = navigationStack.pop();
                if (prev.type === 'Collection') openCollection(prev.name, true);
                else if (prev.type === 'FolderView') openFolder(prev.name, prev.originType, prev.parentNav, true);
            } else { document.getElementById('listViewPage').classList.remove('active-view'); }
        }
        function closeDetail() { document.getElementById('detailPage').classList.remove('active-view'); }
        function openCalendar() { updateCalendar(); document.getElementById('calendarPage').classList.add('active-view'); }
        function closeCalendar() { document.getElementById('calendarPage').classList.remove('active-view'); }
        function changeMonth(dir) { calMonth += dir; if(calMonth<0){calMonth=11; calYear--;} else if(calMonth>11){calMonth=0; calYear++;} updateCalendar(); }
        function updateCalendar() {
            const first = new Date(calYear, calMonth, 1).getDay();
            const days = new Date(calYear, calMonth + 1, 0).getDate();
            const adj = first === 0 ? 6 : first - 1;
            document.getElementById('calendarMonthLabel').innerText = new Date(calYear, calMonth).toLocaleString('es-ES', {month: 'long'});
            document.getElementById('calendarYearLabel').innerText = calYear;
            let html = '';
            for(let i=0; i<adj; i++) html += '<div class="calendar-day"></div>';
            for(let d=1; d<=days; d++) {
                const dk = `${d.toString().padStart(2,'0')}/${(calMonth+1).toString().padStart(2,'0')}/${calYear}`;
                const b = myLibrary.find(x => x.endDate === dk);
                html += `<div class="calendar-day"><span class="day-number ${dk === getCurrentDate() ? 'today' : ''}">${d}</span>${b ? `<img src="${b.cover}" class="calendar-book-thumb" onclick="viewDetail(${b.id})">` : ''}</div>`;
            }
            document.getElementById('calendarDaysGrid').innerHTML = html;
        }

        function openCollection(type, back = false) {
            if (!back) navigationStack = [];
            let groups = {};
            const isBaseType = ['Autoconclusivo', 'Serie', 'Saga', 'Bilog√≠a', 'Trilog√≠a', 'Sin finalizar'].includes(type);
            
            if (type === 'Writer') {
                myLibrary.forEach(b => { const a = b.author || 'Autor Desconocido'; if(!groups[a]) groups[a]=[]; groups[a].push(b); });
                document.getElementById('listTitle').innerText = 'Escritores';
            } else if (type === 'Publisher') {
                myLibrary.forEach(b => { if(b.publisher){ if(!groups[b.publisher]) groups[b.publisher]=[]; groups[b.publisher].push(b); } });
                document.getElementById('listTitle').innerText = 'Editoriales';
            } else if (type === 'Autoconclusivo') {
                const books = myLibrary.filter(b => b.seriesType === 'Autoconclusivo');
                document.getElementById('listTitle').innerText = 'Autoconclusivos';
                document.getElementById('listSubtitle').innerText = `${books.length} libros`;
                document.getElementById('listItemsContainer').innerHTML = books.map(b => `<div class="book-item-container" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="book-cover-only"></div>`).join('');
                document.getElementById('listViewPage').classList.add('active-view');
                return;
            } else if (isBaseType) {
                myLibrary.filter(b => b.seriesType === type).forEach(b => { if(b.seriesName){ if(!groups[b.seriesName]) groups[b.seriesName]=[]; groups[b.seriesName].push(b); } });
                document.getElementById('listTitle').innerText = type;
            }
            
            document.getElementById('listSubtitle').innerText = `${Object.keys(groups).length} categor√≠as`;
            document.getElementById('listItemsContainer').innerHTML = Object.keys(groups).sort().map(name => {
                const books = groups[name];
                return `<div class="folder-card" onclick="openFolder('${name.replace(/'/g, "\\'")}', '${type}', {type: 'Collection', name: '${type}'})">
                    <div class="folder-badge">${books.length}</div>
                    <div class="folder-stack"><img src="${books[0].cover}" class="stack-main"></div>
                    <p class="text-[10px] font-bold text-white truncate w-full px-1">${name}</p>
                </div>`;
            }).join('');
            document.getElementById('listViewPage').classList.add('active-view');
        }

        function openFolder(name, type, parentNav, back = false) {
            if (!back) navigationStack.push(parentNav);
            const books = myLibrary.filter(b => type === 'Writer' ? (b.author === name) : (type === 'Publisher' ? b.publisher === name : b.seriesName === name));
            document.getElementById('listTitle').innerText = name;
            document.getElementById('listSubtitle').innerText = `${books.length} libros`;
            document.getElementById('listItemsContainer').innerHTML = books.map(b => `<div class="book-item-container" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="book-cover-only"></div>`).join('');
            document.getElementById('listViewPage').classList.add('active-view');
        }

        window.onload = renderAll;
    </script>
</body>
</html>const APP_KEY = 'bookjournal_carlota_v1';
        let myLibrary = JSON.parse(localStorage.getItem(APP_KEY)) || [];
        let readingLogs = JSON.parse(localStorage.getItem(APP_KEY + '_logs')) || [];
        let dailyGoal = parseInt(localStorage.getItem(APP_KEY + '_goal')) || 60;
        let annualGoal = parseInt(localStorage.getItem(APP_KEY + '_annual_goal')) || 12;
        
        let editingId = null;
        let currentCover = null;
        let currentRating = 0;
        let isTimerRunning = false;
        let timerSeconds = 0;
        let timerInterval = null;
        let calMonth = new Date().getMonth();
        let calYear = new Date().getFullYear();
        let navigationStack = [];

        function save() {
            localStorage.setItem(APP_KEY, JSON.stringify(myLibrary));
            localStorage.setItem(APP_KEY + '_logs', JSON.stringify(readingLogs));
            localStorage.setItem(APP_KEY + '_goal', dailyGoal);
            localStorage.setItem(APP_KEY + '_annual_goal', annualGoal);
            updateStats();
        }

        function updateStreakUI() {
            const todayStr = getCurrentDate();
            const activityByDate = {};
            readingLogs.forEach(l => {
                activityByDate[l.date] = (activityByDate[l.date] || 0) + (l.duration || 0);
            });

            const todayMinutes = Math.floor((activityByDate[todayStr] || 0) / 60);
            
            let streak = 0;
            let checkDate = new Date();
            
            while (true) {
                const dStr = `${checkDate.getDate().toString().padStart(2,'0')}/${(checkDate.getMonth() + 1).toString().padStart(2,'0')}/${checkDate.getFullYear()}`;
                const mins = Math.floor((activityByDate[dStr] || 0) / 60);
                
                if (mins >= dailyGoal) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (dStr === todayStr) {
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            document.getElementById('streakDays').innerText = streak;
            document.getElementById('goalLabel').innerText = dailyGoal;
            const percentage = Math.min((todayMinutes / dailyGoal) * 100, 100);
            document.getElementById('goalFill').style.width = percentage + '%';

            // Actualizar Meta Anual
            updateAnnualGoalUI();
        }

        function updateAnnualGoalUI() {
            const currentYear = new Date().getFullYear().toString();
            const booksThisYear = myLibrary.filter(b => {
                if (b.status !== 'finished' || !b.endDate) return false;
                const parts = b.endDate.split('/');
                return parts[2] === currentYear;
            });

            const count = booksThisYear.length;
            document.getElementById('annualCount').innerText = count;
            document.getElementById('annualGoalLabel').innerText = annualGoal;
            const percentage = Math.min((count / annualGoal) * 100, 100);
            document.getElementById('annualGoalFill').style.width = percentage + '%';
        }

        // --- RESUMEN ANUAL LOGIC ---
        function openAnnualReport() {
            const year = new Date().getFullYear();
            const yearStr = year.toString();
            document.getElementById('reportYearLabel').innerText = year;
            
            const booksThisYear = myLibrary.filter(b => {
                if (b.status !== 'finished' || !b.endDate) return false;
                return b.endDate.split('/')[2] === yearStr;
            });

            // Stats
            document.getElementById('reportTotalBooks').innerText = booksThisYear.length;
            const totalPages = booksThisYear.reduce((acc, b) => acc + (b.pageTotal || 0), 0);
            document.getElementById('reportTotalPages').innerText = totalPages;

            const authors = {};
            booksThisYear.forEach(b => {
                if (b.author && b.author !== 'Autor Desconocido') {
                    authors[b.author] = (authors[b.author] || 0) + 1;
                }
            });
            let topAuthor = "---";
            let maxA = 0;
            for (let a in authors) if(authors[a] > maxA) { maxA = authors[a]; topAuthor = a; }
            document.getElementById('reportTopAuthor').innerText = topAuthor;

            // Chart
            const monthlyCounts = new Array(12).fill(0);
            booksThisYear.forEach(b => {
                const monthIdx = parseInt(b.endDate.split('/')[1]) - 1;
                monthlyCounts[monthIdx]++;
            });
            const maxMonth = Math.max(...monthlyCounts, 1);
            document.getElementById('reportChart').innerHTML = monthlyCounts.map(count => {
                const h = (count / maxMonth) * 100;
                return `<div class="chart-bar" style="height: ${h}%"></div>`;
            }).join('');

            // Top 3
            const top3 = [...booksThisYear].sort((a,b) => (b.rating || 0) - (a.rating || 0)).slice(0, 3);
            document.getElementById('reportTopBooks').innerHTML = top3.map((b, i) => `
                <div class="flex items-center gap-4 bg-zinc-900/30 p-4 rounded-2xl border border-white/5" onclick="viewDetail(${b.id})">
                    <div class="text-xl font-bold italic opacity-20 serif">#${i+1}</div>
                    <img src="${b.cover}" class="w-12 h-16 object-cover rounded shadow">
                    <div class="flex-1 truncate">
                        <h4 class="text-sm font-bold truncate">${b.title}</h4>
                        <div class="text-[#ffd700] text-[10px] mt-1">${'‚òÖ'.repeat(b.rating)}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('annualReportPage').classList.add('active-view');
        }

        function closeAnnualReport() {
            document.getElementById('annualReportPage').classList.remove('active-view');
        }

        function openGoalModal() {
            document.getElementById('goalInput').value = dailyGoal;
            document.getElementById('goalModal').classList.remove('hidden');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.add('hidden');
        }

        function saveGoal() {
            const val = parseInt(document.getElementById('goalInput').value);
            if (!isNaN(val) && val > 0) {
                dailyGoal = val;
                save();
                closeGoalModal();
                updateStreakUI();
            }
        }

        // Funciones Meta Anual
        function openAnnualGoalModal() {
            document.getElementById('annualGoalInput').value = annualGoal;
            document.getElementById('annualGoalModal').classList.remove('hidden');
        }

        function closeAnnualGoalModal() {
            document.getElementById('annualGoalModal').classList.add('hidden');
        }

        function saveAnnualGoal() {
            const val = parseInt(document.getElementById('annualGoalInput').value);
            if (!isNaN(val) && val > 0) {
                annualGoal = val;
                save();
                closeAnnualGoalModal();
                updateAnnualGoalUI();
            }
        }

        function checkUnreleased(book) {
            if (!book.year || !book.month || !book.day) return false;
            const release = new Date(book.year, book.month - 1, book.day);
            const today = new Date();
            today.setHours(0,0,0,0);
            return release > today;
        }

        function getCurrentDate() {
            const today = new Date();
            return `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth() + 1).toString().padStart(2,'0')}/${today.getFullYear()}`;
        }

        function parseDate(str) {
            if(!str) return null;
            const parts = str.split('/');
            if(parts.length < 3) return null;
            return new Date(parts[2], parts[1]-1, parts[0]);
        }

        function calculateReadingMetrics(bookId) {
            const logs = readingLogs.filter(l => l.bookId === bookId);
            if (logs.length === 0) return null;

            let totalSeconds = 0;
            let totalPages = 0;
            logs.forEach(l => {
                totalSeconds += l.duration || 0;
                totalPages += l.pagesRead || 0;
            });

            if (totalPages === 0 || totalSeconds === 0) return null;

            const pagesPerMinute = (totalPages / (totalSeconds / 60)).toFixed(2);
            const minutesPerPage = (totalSeconds / 60 / totalPages).toFixed(2);
            
            return {
                ppm: pagesPerMinute,
                mpp: minutesPerPage,
                avgSession: Math.round(totalSeconds / logs.length / 60)
            };
        }

        function getEstimatedTime(book) {
            const metrics = calculateReadingMetrics(book.id);
            if (!metrics || !book.pageTotal) return null;

            const remainingPages = book.pageTotal - (book.pageNow || 0);
            if (remainingPages <= 0) return "Terminado";

            const totalMinutesNeeded = remainingPages * parseFloat(metrics.mpp);
            const hours = Math.floor(totalMinutesNeeded / 60);
            const minutes = Math.round(totalMinutesNeeded % 60);

            if (hours === 0) return `${minutes} min restates`;
            return `${hours}h ${minutes}m restantes`;
        }

        function updateStats() {
            const unreleased = myLibrary.filter(b => checkUnreleased(b));
            const wishlist = myLibrary.filter(b => b.status === 'wishlist' && !checkUnreleased(b));
            const finished = myLibrary.filter(b => b.status === 'finished');

            document.getElementById('countUnreleased').innerText = unreleased.length;
            document.getElementById('countWishlist').innerText = wishlist.length;
            document.getElementById('countFinished').innerText = finished.length;
            
            document.getElementById('countWriters').innerText = new Set(myLibrary.map(b => b.author).filter(a => a && a !== 'Autor Desconocido')).size;
            document.getElementById('countPublishers').innerText = new Set(myLibrary.map(b => b.publisher).filter(Boolean)).size;
            
            const collectionMapping = {
                'Autoconclusivo': 'stat-autoconclusivo',
                'Serie': 'stat-serie',
                'Saga': 'stat-saga',
                'Bilog√≠a': 'stat-bilogia',
                'Trilog√≠a': 'stat-trilogia',
                'Sin finalizar': 'stat-sinfinalizar'
            };

            Object.keys(collectionMapping).forEach(type => {
                const elId = collectionMapping[type];
                const el = document.getElementById(elId);
                if (el) {
                    const booksInType = myLibrary.filter(b => b.seriesType === type);
                    if (type === 'Autoconclusivo') {
                        el.innerText = `${booksInType.length} libros`;
                    } else {
                        const uniqueSeries = new Set(booksInType.map(b => b.seriesName).filter(name => name && name.trim() !== ''));
                        const count = uniqueSeries.size;
                        el.innerText = `${count} ${count === 1 ? 'colecci√≥n' : 'colecciones'}`;
                    }
                }
            });

            document.getElementById('currentDateLabel').innerText = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }).toUpperCase();
            updateStreakUI();
        }

        function renderActive() {
            const container = document.getElementById('activeSection');
            const active = myLibrary.find(b => b.status === 'reading');
            
            if (!active) {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            const porcentaje = Math.min(((active.pageNow || 0) / (active.pageTotal || 1)) * 100, 100);
            const estimate = getEstimatedTime(active);
            const metrics = calculateReadingMetrics(active.id);

            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="w-full px-4 mb-2 flex justify-between items-end">
                        <span class="text-xl font-medium text-gray-400 serif italic">Leyendo ahora</span>
                        <div class="text-xl font-medium text-gray-400">P√°g. ${active.pageNow} <span class="text-xs opacity-40">/ ${active.pageTotal}</span></div>
                    </div>
                    <div class="bookmory-card-container w-full" onclick="viewDetail(${active.id})">
                        <div class="progress-track"><div class="progress-fill" style="width: ${porcentaje}%"></div></div>
                        <h3 class="text-2xl font-medium text-white mb-1 leading-tight">${active.title}</h3>
                        <p class="text-stone-500 text-xs mb-4 uppercase tracking-widest font-bold">${active.author}</p>
                        <div class="flex gap-6 items-start">
                            <img src="${active.cover || ''}" class="book-cover-bm">
                            <div class="flex-1 pt-2 flex flex-col justify-between min-h-[160px]">
                                <div class="flex flex-col gap-1 items-start">
                                    <span class="text-sky-500/80 text-[10px] font-bold uppercase border border-sky-500/20 px-2 py-1 rounded-lg">${active.format}</span>
                                    ${metrics ? `<span class="text-amber-500/80 text-[8px] font-bold uppercase mt-1">‚ö° ${metrics.ppm} p√°g/min</span>` : ''}
                                </div>
                                <div class="flex items-center gap-4 bg-zinc-900/50 p-3 rounded-2xl w-fit border border-white/5">
                                    <button onclick="event.stopPropagation(); openTimer()" class="w-8 h-8 flex items-center justify-center bg-sky-900/40 rounded-full">‚è±</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="time-remaining-badge">
                        <span>${Math.round(porcentaje)}%</span>
                        ${estimate ? `<span class="opacity-30 mx-1">|</span><span>${estimate}</span>` : ''}
                    </div>
                </div>`;
        }

        function renderAll() { 
            document.querySelectorAll('.full-page-view').forEach(view => view.classList.remove('active-view'));
            document.getElementById('mainPage').style.display = 'block';
            renderActive(); 
            updateStats(); 
        }

        function toggleAddMenu() { 
            editingId = null; 
            resetForm(); 
            document.getElementById('modalTitle').innerText = "A√±adir Libro"; 
            document.getElementById('deleteBtn').classList.add('hidden'); 
            document.getElementById('bookModal').classList.remove('hidden'); 
            handleStatusChange();
        }

        function closeModal() { document.getElementById('bookModal').classList.add('hidden'); }
        function toggleSeriesFields() { document.getElementById('dynamicSeriesFields').classList.toggle('hidden', document.getElementById('formSeriesType').value === 'Autoconclusivo'); }
        
        function handleStatusChange() {
            const status = document.getElementById('formStatus').value;
            const datesContainer = document.getElementById('manualDatesContainer');
            const endField = document.getElementById('formEndDateField');
            const ratingContainer = document.getElementById('formRatingContainer');

            ratingContainer.classList.toggle('hidden', status !== 'finished');
            
            if (status === 'wishlist') {
                datesContainer.classList.add('hidden');
            } else {
                datesContainer.classList.remove('hidden');
                endField.classList.toggle('hidden', status !== 'finished');
            }
        }

        function setRating(val, context) {
            currentRating = val;
            const containerId = context === 'form' ? 'formStarRating' : 'timerStarRating';
            const btns = document.querySelectorAll(`#${containerId} button`);
            btns.forEach((btn, idx) => btn.classList.toggle('active', idx < val));
        }

        function handleManualCoverUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentCover = ev.target.result;
                document.getElementById('formPreview').src = currentCover;
                document.getElementById('formPreview').classList.remove('hidden');
                document.getElementById('previewPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function processBook() {
            const title = document.getElementById('formTitle').value;
            if (!title) return;
            
            const status = document.getElementById('formStatus').value;
            let startDate = document.getElementById('formManualStartDate').value || null;
            let endDate = document.getElementById('formManualEndDate').value || null;

            if (!editingId) {
                if (status === 'reading' && !startDate) startDate = getCurrentDate();
                if (status === 'finished' && !startDate) startDate = getCurrentDate();
                if (status === 'finished' && !endDate) endDate = getCurrentDate();
            }

            const book = {
                id: editingId || Date.now(),
                title: title,
                author: document.getElementById('formAuthor').value || 'Autor Desconocido',
                pageTotal: parseInt(document.getElementById('formPageTotal').value) || 0,
                pageNow: parseInt(document.getElementById('formPageNow').value) || 0,
                status: status,
                format: document.getElementById('formFormat').value,
                seriesType: document.getElementById('formSeriesType').value,
                seriesName: document.getElementById('formSeriesName').value || '',
                seriesNumber: parseInt(document.getElementById('formSeriesNumber').value) || 0,
                publisher: document.getElementById('formPublisher').value,
                day: parseInt(document.getElementById('formDay').value) || null,
                month: parseInt(document.getElementById('formMonth').value) || null,
                year: parseInt(document.getElementById('formYear').value) || null,
                cover: currentCover,
                rating: status === 'finished' ? currentRating : 0,
                startDate: startDate,
                endDate: status === 'finished' ? endDate : null
            };

            if (editingId) {
                const idx = myLibrary.findIndex(b => b.id === editingId);
                myLibrary[idx] = book;
            } else {
                myLibrary.unshift(book);
            }
            save(); closeModal(); renderAll();
        }

        function editBook(id) {
            const b = myLibrary.find(x => x.id === id);
            if (!b) return;
            editingId = id;
            document.getElementById('formTitle').value = b.title;
            document.getElementById('formAuthor').value = b.author;
            document.getElementById('formPageTotal').value = b.pageTotal;
            document.getElementById('formPageNow').value = b.pageNow;
            document.getElementById('formStatus').value = b.status;
            document.getElementById('formFormat').value = b.format;
            document.getElementById('formSeriesType').value = b.seriesType;
            document.getElementById('formSeriesName').value = b.seriesName || '';
            document.getElementById('formSeriesNumber').value = b.seriesNumber || '';
            document.getElementById('formPublisher').value = b.publisher || '';
            document.getElementById('formDay').value = b.day || '';
            document.getElementById('formMonth').value = b.month || '';
            document.getElementById('formYear').value = b.year || '';
            document.getElementById('formManualStartDate').value = b.startDate || '';
            document.getElementById('formManualEndDate').value = b.endDate || '';

            currentRating = b.rating || 0;
            setRating(currentRating, 'form');
            currentCover = b.cover;
            if (currentCover) {
                document.getElementById('formPreview').src = currentCover;
                document.getElementById('formPreview').classList.remove('hidden');
                document.getElementById('previewPlaceholder').classList.add('hidden');
            }
            toggleSeriesFields();
            handleStatusChange();
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('bookModal').classList.remove('hidden');
        }

        function deleteBook() { if(editingId) { myLibrary = myLibrary.filter(b => b.id !== editingId); save(); closeModal(); renderAll(); } }

        function resetForm() {
            ['formTitle', 'formAuthor', 'formPageTotal', 'formPageNow', 'formSeriesName', 'formSeriesNumber', 'formPublisher', 'formDay', 'formMonth', 'formYear', 'formManualStartDate', 'formManualEndDate'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('formStatus').value = 'wishlist';
            document.getElementById('formSeriesType').value = 'Autoconclusivo';
            document.getElementById('formPreview').classList.add('hidden');
            document.getElementById('previewPlaceholder').classList.remove('hidden');
            currentCover = null; 
            currentRating = 0;
            setRating(0, 'form');
            toggleSeriesFields();
        }

        function openListView(mode) {
            navigationStack = [];
            let books = [];
            let title = "";

            if (mode === 'unreleased') {
                books = myLibrary.filter(b => checkUnreleased(b));
                title = "Pr√≥ximos";
            } else if (mode === 'wishlist') {
                books = myLibrary.filter(b => b.status === 'wishlist' && !checkUnreleased(b));
                title = "Pendientes";
            } else if (mode === 'finished') {
                books = myLibrary.filter(b => b.status === 'finished');
                title = "Le√≠dos";
            }

            document.getElementById('listTitle').innerText = title;
            document.getElementById('listSubtitle').innerText = `${books.length} libros`;
            
            document.getElementById('listItemsContainer').innerHTML = books.map(b => {
                let starsHtml = (b.status === 'finished' && b.rating > 0) ? `<div class="rating-mini">${'‚òÖ'.repeat(b.rating)}</div>` : `<div class="rating-empty"></div>`;
                return `<div class="book-item-container" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="book-cover-only">${starsHtml}</div>`;
            }).join('');

            document.getElementById('listViewPage').classList.add('active-view');
        }

        function viewDetail(id) {
            const b = myLibrary.find(x => x.id === id);
            if (!b) return;
            document.getElementById('detailTitle').innerText = b.title;
            document.getElementById('detailAuthor').innerText = b.author;
            document.getElementById('detailCover').src = b.cover || '';
            
            const starsContainer = document.getElementById('detailRatingDisplay');
            starsContainer.innerHTML = (b.status === 'finished' && b.rating > 0) ? '‚òÖ'.repeat(b.rating) + '<span class="opacity-10">' + '‚òÖ'.repeat(5 - b.rating) + '</span>' : '';

            const metrics = calculateReadingMetrics(b.id);

            document.getElementById('detailStatsGrid').innerHTML = `
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">Editorial</p><p class="text-xs font-medium">${b.publisher || '---'}</p></div>
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">P√°ginas</p><p class="text-xs font-medium">${b.pageTotal}</p></div>
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">Inicio</p><p class="text-xs font-medium">${b.startDate || '---'}</p></div>
                <div class="stat-badge"><p class="text-[9px] text-stone-500 uppercase font-bold mb-1">Fin</p><p class="text-xs font-medium">${b.endDate || '---'}</p></div>
                ${metrics ? `
                <div class="stat-badge col-span-2 flex justify-around py-3 bg-sky-950/20">
                    <div><p class="text-[8px] text-sky-500 uppercase font-bold">Velocidad</p><p class="text-xs font-bold">${metrics.ppm} p√°g/m</p></div>
                    <div><p class="text-[8px] text-sky-500 uppercase font-bold">Ritmo</p><p class="text-xs font-bold">${metrics.mpp} m/p√°g</p></div>
                    <div><p class="text-[8px] text-sky-500 uppercase font-bold">Sesi√≥n Media</p><p class="text-xs font-bold">${metrics.avgSession} min</p></div>
                </div>` : ''}`;
            
            document.getElementById('detailStartReadingContainer').classList.toggle('hidden', b.status !== 'wishlist' || checkUnreleased(b));
            document.getElementById('detailStartReadingBtn').onclick = () => { b.status = 'reading'; b.startDate = getCurrentDate(); save(); closeDetail(); renderAll(); };
            document.getElementById('editFromDetailBtn').onclick = () => { closeDetail(); editBook(id); };
            document.getElementById('detailPage').classList.add('active-view');
        }

        function openTimer() {
            const active = myLibrary.find(b => b.status === 'reading');
            if (!active) return;
            document.getElementById('timerBookTitle').innerText = active.title;
            document.getElementById('timerBookAuthor').innerText = active.author;
            document.getElementById('timerBookCover').src = active.cover || '';
            document.getElementById('timerPage').classList.add('active-view');
            if(!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    const h = Math.floor(timerSeconds/3600).toString().padStart(2,'0'), m = Math.floor((timerSeconds%3600)/60).toString().padStart(2,'0'), s = (timerSeconds%60).toString().padStart(2,'0');
                    document.getElementById('timerDisplay').innerText = `${h}:${m}:${s}`;
                }, 1000);
            }
        }

        function toggleTimer() { if(isTimerRunning){ clearInterval(timerInterval); isTimerRunning=false; document.getElementById('timerBtnIcon').innerText='‚ñ∂'; } else openTimer(); }
        
        function stopTimerAndRegister() { 
            const a = myLibrary.find(b => b.status === 'reading'); 
            if(a){ 
                document.getElementById('timerNewPageInput').value=a.pageNow; 
                const checkStats = () => {
                    const p = parseInt(document.getElementById('timerNewPageInput').value);
                    const pagesRead = Math.max(0, p - a.pageNow);
                    const isF = p >= a.pageTotal && a.pageTotal > 0;
                    
                    const sessionMinutes = timerSeconds / 60;
                    const ppm = sessionMinutes > 0 ? (pagesRead / sessionMinutes).toFixed(2) : 0;
                    
                    document.getElementById('sessionStatsLabel').innerText = `Has le√≠do ${pagesRead} p√°ginas (${ppm} PPM)`;
                    document.getElementById('standardProgressInputs').classList.toggle('hidden', isF);
                    document.getElementById('ratingInputContainer').classList.toggle('hidden', !isF);
                };
                document.getElementById('timerNewPageInput').oninput = checkStats;
                checkStats();
                document.getElementById('timerProgressModal').style.display='flex'; 
            } 
        }

        function confirmTimerProgress() {
            const a = myLibrary.find(b => b.status === 'reading'), p = parseInt(document.getElementById('timerNewPageInput').value);
            if(a && !isNaN(p)){
                const pagesRead = Math.max(0, p - a.pageNow);
                a.pageNow = p;
                
                readingLogs.push({ 
                    date: getCurrentDate(), 
                    bookId: a.id, 
                    duration: timerSeconds,
                    pagesRead: pagesRead
                });

                if(p >= a.pageTotal && a.pageTotal > 0){ 
                    a.status = 'finished'; 
                    a.endDate = getCurrentDate(); 
                    a.rating = currentRating; 
                }
                save();
            }
            closeTimer(); hideTimerProgress(); renderAll();
        }

        function hideTimerProgress() { document.getElementById('timerProgressModal').style.display = 'none'; document.getElementById('standardProgressInputs').classList.remove('hidden'); document.getElementById('ratingInputContainer').classList.add('hidden'); currentRating = 0; setRating(0, 'timer'); }
        function closeTimer() { clearInterval(timerInterval); isTimerRunning = false; timerSeconds = 0; document.getElementById('timerPage').classList.remove('active-view'); }

        function searchInMyLibrary() {
            const t = document.getElementById('searchInput').value.toLowerCase(), r = document.getElementById('quickSearchResults');
            if(t.length > 0){
                const f = myLibrary.filter(b => b.title.toLowerCase().includes(t) || b.author.toLowerCase().includes(t));
                r.innerHTML = f.map(b => `<div class="bg-zinc-900/50 p-4 rounded-2xl flex gap-4 items-center border border-white/5" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="w-10 h-14 object-cover rounded shadow"><div><h4 class="text-sm font-bold">${b.title}</h4><p class="text-[9px] text-stone-500 uppercase font-bold">${b.author}</p></div></div>`).join('');
            } else r.innerHTML = '';
        }

        function handleListBack() {
            if (navigationStack.length > 0) {
                const prev = navigationStack.pop();
                if (prev.type === 'Collection') openCollection(prev.name, true);
                else if (prev.type === 'FolderView') openFolder(prev.name, prev.originType, prev.parentNav, true);
            } else { document.getElementById('listViewPage').classList.remove('active-view'); }
        }
        function closeDetail() { document.getElementById('detailPage').classList.remove('active-view'); }
        function openCalendar() { updateCalendar(); document.getElementById('calendarPage').classList.add('active-view'); }
        function closeCalendar() { document.getElementById('calendarPage').classList.remove('active-view'); }
        function changeMonth(dir) { calMonth += dir; if(calMonth<0){calMonth=11; calYear--;} else if(calMonth>11){calMonth=0; calYear++;} updateCalendar(); }
        function updateCalendar() {
            const first = new Date(calYear, calMonth, 1).getDay();
            const days = new Date(calYear, calMonth + 1, 0).getDate();
            const adj = first === 0 ? 6 : first - 1;
            document.getElementById('calendarMonthLabel').innerText = new Date(calYear, calMonth).toLocaleString('es-ES', {month: 'long'});
            document.getElementById('calendarYearLabel').innerText = calYear;
            let html = '';
            for(let i=0; i<adj; i++) html += '<div class="calendar-day"></div>';
            for(let d=1; d<=days; d++) {
                const dk = `${d.toString().padStart(2,'0')}/${(calMonth+1).toString().padStart(2,'0')}/${calYear}`;
                const b = myLibrary.find(x => x.endDate === dk);
                html += `<div class="calendar-day"><span class="day-number ${dk === getCurrentDate() ? 'today' : ''}">${d}</span>${b ? `<img src="${b.cover}" class="calendar-book-thumb" onclick="viewDetail(${b.id})">` : ''}</div>`;
            }
            document.getElementById('calendarDaysGrid').innerHTML = html;
        }

        function openCollection(type, back = false) {
            if (!back) navigationStack = [];
            let groups = {};
            const isBaseType = ['Autoconclusivo', 'Serie', 'Saga', 'Bilog√≠a', 'Trilog√≠a', 'Sin finalizar'].includes(type);
            
            if (type === 'Writer') {
                myLibrary.forEach(b => { const a = b.author || 'Autor Desconocido'; if(!groups[a]) groups[a]=[]; groups[a].push(b); });
                document.getElementById('listTitle').innerText = 'Escritores';
            } else if (type === 'Publisher') {
                myLibrary.forEach(b => { if(b.publisher){ if(!groups[b.publisher]) groups[b.publisher]=[]; groups[b.publisher].push(b); } });
                document.getElementById('listTitle').innerText = 'Editoriales';
            } else if (type === 'Autoconclusivo') {
                const books = myLibrary.filter(b => b.seriesType === 'Autoconclusivo');
                document.getElementById('listTitle').innerText = 'Autoconclusivos';
                document.getElementById('listSubtitle').innerText = `${books.length} libros`;
                document.getElementById('listItemsContainer').innerHTML = books.map(b => `<div class="book-item-container" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="book-cover-only"></div>`).join('');
                document.getElementById('listViewPage').classList.add('active-view');
                return;
            } else if (isBaseType) {
                myLibrary.filter(b => b.seriesType === type).forEach(b => { if(b.seriesName){ if(!groups[b.seriesName]) groups[b.seriesName]=[]; groups[b.seriesName].push(b); } });
                document.getElementById('listTitle').innerText = type;
            }
            
            document.getElementById('listSubtitle').innerText = `${Object.keys(groups).length} categor√≠as`;
            document.getElementById('listItemsContainer').innerHTML = Object.keys(groups).sort().map(name => {
                const books = groups[name];
                return `<div class="folder-card" onclick="openFolder('${name.replace(/'/g, "\\'")}', '${type}', {type: 'Collection', name: '${type}'})">
                    <div class="folder-badge">${books.length}</div>
                    <div class="folder-stack"><img src="${books[0].cover}" class="stack-main"></div>
                    <p class="text-[10px] font-bold text-white truncate w-full px-1">${name}</p>
                </div>`;
            }).join('');
            document.getElementById('listViewPage').classList.add('active-view');
        }

        function openFolder(name, type, parentNav, back = false) {
            if (!back) navigationStack.push(parentNav);
            const books = myLibrary.filter(b => type === 'Writer' ? (b.author === name) : (type === 'Publisher' ? b.publisher === name : b.seriesName === name));
            document.getElementById('listTitle').innerText = name;
            document.getElementById('listSubtitle').innerText = `${books.length} libros`;
            document.getElementById('listItemsContainer').innerHTML = books.map(b => `<div class="book-item-container" onclick="viewDetail(${b.id})"><img src="${b.cover || ''}" class="book-cover-only"></div>`).join('');
            document.getElementById('listViewPage').classList.add('active-view');
        }

        window.onload = renderAll;
